<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Lesetraining ‚Äì L√ºcke f√ºllen (au/ei/eu)</title>
<style>
  :root{
    font-family: "Comic Sans MS","Segoe UI",system-ui,sans-serif;
    background: radial-gradient(1200px 600px at 15% 10%, #eef2ff 0%, #fdf2f8 42%, #ecfeff 100%);
  }
  body{
    margin:0;
    min-height:100vh;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:18px;
    box-sizing:border-box;
  }
  .app{
    background: rgba(255,255,255,0.92);
    backdrop-filter: blur(6px);
    border: 1px solid rgba(199,210,254,0.8);
    border-radius: 20px;
    box-shadow: 0 14px 40px rgba(0,0,0,0.10);
    padding: 1.7rem 2rem;
    max-width: 900px;
    width: 100%;
    box-sizing:border-box;
  }
  header{
    display:flex;
    gap:12px;
    align-items:flex-start;
    justify-content:space-between;
    flex-wrap:wrap;
    margin-bottom:.6rem;
  }
  h1{ margin:0; font-size:1.65rem; }
  .subtitle{ margin:.2rem 0 1rem 0; color:#4b5563; line-height:1.35; font-weight:800; }

  .card{
    background: rgba(255,255,255,0.86);
    border: 1px solid rgba(199,210,254,0.7);
    border-radius: 16px;
    padding: 14px;
    box-shadow: 0 10px 26px rgba(0,0,0,0.06);
  }
  .hidden{ display:none; }
  .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
  .row > *{ flex: 0 0 auto; }

  .big-label{
    font-weight:1000;
    color:#111827;
    font-size:1.05rem;
    display:flex;
    align-items:center;
    gap:8px;
  }
  input[type="text"]{
    padding:.65rem .8rem;
    border-radius: 14px;
    border: 3px solid #c7d2fe;
    outline:none;
    font-weight:1000;
    font-size:1.05rem;
    min-width: 210px;
  }

  .pill{
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding:.55rem .7rem;
    border-radius:999px;
    border: 2px solid #c7d2fe;
    background:#eef2ff;
    font-weight:1000;
  }
  .pill select{
    border:none;
    background:transparent;
    font-weight:1000;
    cursor:pointer;
    outline:none;
  }

  .mode-grid{
    display:grid;
    grid-template-columns: repeat(2, minmax(0,1fr));
    gap:.6rem;
    margin:.75rem 0 .5rem 0;
  }
  @media (min-width: 820px){
    .mode-grid{ grid-template-columns: repeat(5, minmax(0,1fr)); }
  }
  .mode-btn{
    padding: .85rem .65rem;
    border-radius: 16px;
    border: 2px solid #d1d5db;
    background: linear-gradient(180deg, #ffffff 0%, #f9fafb 100%);
    font-size: .98rem;
    font-weight: 1000;
    cursor:pointer;
    transition: transform .05s ease, box-shadow .15s ease, border-color .15s ease;
  }
  .mode-btn:hover{
    border-color:#a5b4fc;
    box-shadow: 0 8px 22px rgba(99,102,241,0.12);
  }
  .mode-btn.selected{
    border-color:#4f46e5;
    background: linear-gradient(180deg, #4f46e5 0%, #2563eb 100%);
    color:#fff;
    box-shadow: 0 10px 26px rgba(37,99,235,0.30);
  }
  .mode-btn:active{ transform: translateY(1px); }

  .primary-btn{
    padding:.82rem 1.15rem;
    font-size:1.08rem;
    border-radius:999px;
    border:none;
    cursor:pointer;
    background: linear-gradient(180deg, #2563eb 0%, #1d4ed8 100%);
    color:#fff;
    font-weight:1000;
    box-shadow: 0 10px 22px rgba(37,99,235,0.22);
    transition: transform .05s ease, filter .15s ease;
  }
  .primary-btn:hover{ filter: brightness(1.03); }
  .primary-btn:active{ transform: translateY(1px); }
  .primary-btn:disabled{ background:#9ca3af; box-shadow:none; cursor:not-allowed; }

  .ghost-btn{
    padding:.78rem 1rem;
    font-size:1rem;
    border-radius:999px;
    border: 2px solid #c7d2fe;
    background:#ffffff;
    cursor:pointer;
    font-weight:1000;
  }
  .ghost-btn:hover{ background:#eef2ff; }

  .danger-btn{
    padding:.78rem 1rem;
    font-size:1rem;
    border-radius:999px;
    border: 2px solid #fecaca;
    background:#fff;
    cursor:pointer;
    font-weight:1000;
  }
  .danger-btn:hover{ background:#fef2f2; }

  /* Quiz */
  .quiz{ text-align:center; margin-top: 10px; }
  .word{
    font-family: "Comic Sans MS", sans-serif;
    font-size: 3.1rem;
    letter-spacing: 0.16em;
    margin: .7rem 0 .45rem;
    user-select:none;
  }
  .pattern-info{
    font-size: 1.02rem;
    color:#374151;
    margin-bottom:.7rem;
    font-weight:1000;
  }
  #speak-btn{
    padding:.72rem 1rem;
    font-size:1.05rem;
    border-radius:16px;
    cursor:pointer;
    border: 3px solid #c7d2fe;
    background: #eef2ff;
    margin-bottom:.55rem;
    font-weight:1000;
  }
  #speak-btn:hover{ background:#e0e7ff; }

  .letters{
    margin-top: .85rem;
    display:grid;
    grid-template-columns: repeat(3, 1fr);
    gap:.65rem;
    max-width: 560px;
    margin-left:auto;
    margin-right:auto;
  }
  .letter-btn{
    font-family: "Comic Sans MS", sans-serif;
    padding: .9rem .7rem;
    border-radius: 18px;
    background: linear-gradient(180deg, #e0f2fe 0%, #e0e7ff 100%);
    border: 3px solid #c7d2fe;
    cursor:pointer;
    font-size: 1.6rem;
    font-weight: 1000;
    line-height:1.05;
  }
  .letter-btn:hover{ filter: brightness(1.03); }
  .letter-btn:disabled{ opacity:.55; cursor:default; }

  .btn-sub{
    display:block;
    font-size: 1.02rem;
    font-weight: 1000;
    margin-top: .25rem;
    opacity: .92;
  }
  .red{ color:#dc2626; font-weight:1000; }

  .feedback{
    min-height:1.6rem;
    font-size:1.25rem;
    margin-top:.9rem;
    font-weight:1000;
  }
  .ok{ color:#15803d; }
  .err{ color:#b91c1c; }

  .stats{
    margin-top:.35rem;
    font-size:1rem;
    color:#111827;
    font-weight:1000;
  }

  textarea{
    width:100%;
    min-height: 260px;
    border-radius: 14px;
    border: 2px solid #c7d2fe;
    padding: 12px;
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
    font-size: .92rem;
    box-sizing:border-box;
  }
  .small{
    color:#6b7280;
    font-weight:900;
    font-size:.95rem;
    line-height:1.35;
  }
</style>
</head>

<body>
<div class="app">
  <header>
    <div>
      <h1>Lesetraining (au / ei / eu)</h1>
      <div class="subtitle">H√∂r zu üëÇ ‚Äì f√ºlle die L√ºcke ‚Äì klick die richtige Karte.</div>
    </div>
    <div class="row">
      <span class="pill">
        <span>Filter:</span>
        <select id="filter-select" aria-label="Filter">
          <option value="all">au + ei + eu</option>
          <option value="au">nur au</option>
          <option value="ei">nur ei</option>
          <option value="eu">nur eu</option>
        </select>
      </span>

      <span class="pill">
        <span>Pause:</span>
        <select id="pause-select" aria-label="Pause">
          <option value="15000">15s</option>
          <option value="20000" selected>20s</option>
          <option value="30000">30s</option>
        </select>
      </span>

      <span class="pill">
        <span>Ziel:</span>
        <select id="target-select" aria-label="Ziel richtig">
          <option value="10">10</option>
          <option value="20" selected>20</option>
          <option value="30">30</option>
        </select>
      </span>
    </div>
  </header>

  <!-- START -->
  <div id="start-screen" class="card">
    <div class="row" style="justify-content:space-between;">
      <div class="row">
        <div class="big-label">üë§ Name:</div>
        <input id="child-name" type="text" placeholder="z.B. Mia" maxlength="24" />
      </div>

      <div class="row">
        <span class="pill" title="Stimme (Browser)">
          <span>üó£Ô∏è Stimme:</span>
          <select id="voice-select" aria-label="Stimme">
            <option value="">(l√§dt‚Ä¶)</option>
          </select>
        </span>
      </div>
    </div>

    <div class="mode-grid" id="mode-grid" style="margin-top:12px;">
      <button type="button" class="mode-btn" data-mode="start">1) Anfang</button>
      <button type="button" class="mode-btn" data-mode="end">2) Ende</button>
      <button type="button" class="mode-btn" data-mode="vowel">3) Vokale</button>
      <button type="button" class="mode-btn" data-mode="cons">4) Konson.</button>
      <button type="button" class="mode-btn" data-mode="diph">5) au/ei/eu</button>
    </div>

    <div class="small" id="start-info">Bitte Name eintragen und Modus w√§hlen.</div>

    <div class="row" style="margin-top:10px;">
      <button id="start-btn" class="primary-btn" disabled type="button">‚ñ∂Ô∏è Start</button>
      <button id="load-last-btn" class="ghost-btn" type="button">üë§ letztes Kind</button>
      <button id="reset-history-btn" class="danger-btn" type="button">üßπ Diagnose l√∂schen</button>
    </div>

    <div class="small" style="margin-top:10px;">
      Am Ende bekommst du einen Text-Report zum Kopieren (Diagnose wird pro Kind gespeichert).
    </div>
  </div>

  <!-- QUIZ -->
  <div id="quiz-screen" class="card hidden">
    <div class="row" style="justify-content:space-between;">
      <div class="small" id="whoami">Kind: ‚Äì</div>
      <div class="row">
        <button id="abort-btn" class="danger-btn" type="button">‚èπ Spiel beenden</button>
      </div>
    </div>

    <div class="quiz">
      <div class="word" id="word-display">_</div>
      <button id="speak-btn" type="button">üîä Nochmal h√∂ren</button>
      <div class="pattern-info" id="pattern-info"></div>

      <div class="letters" id="letters"></div>

      <div class="feedback" id="feedback"></div>
      <div class="stats" id="stats"></div>

      <button id="finish-btn" class="hidden primary-btn" type="button">Fertig ‚úî</button>
    </div>

    <!-- REPORT -->
    <div id="report" class="hidden" style="margin-top:12px;">
      <div class="row" style="justify-content:space-between; align-items:flex-end;">
        <div>
          <div style="font-weight:1000; font-size:1.1rem;">üìã Auswertung (kopieren)</div>
          <div class="small">Klick auf ‚ÄûKopieren‚Äú und f√ºge den Text in LearningView / Mail / Notizen ein.</div>
        </div>
        <div class="row">
          <button id="copy-report" class="ghost-btn" type="button">üìã Kopieren</button>
        </div>
      </div>
      <textarea id="report-text" readonly></textarea>
    </div>
  </div>
</div>

<script>
/* =========================================================
   WORTLISTEN: NUR aus dem Chat (unver√§ndert)
   ========================================================= */
const WOERTER_AU = [
  "Auto","Auge","auch","aus","auf","Haus","Maus","Baum","Zaun","Bauch",
  "Faust","Pause","Kauf","laut","Laub","Tau","Sau","Haut","Sauer","Traum",
  "Raum","Kraut","Staub","brauch","laufen","kaufen","tauchen","bauen","saufen","raufen"
];

const WOERTER_EU = [
  "Eule","heute","Feuer","neun","neu","Leute","Beute","Freund","freuen","treu",
  "Zeug","Teufel","euern","keusch","Heu","Euro","Reue","Scheu","deuten","leuchten",
  "Beule","Keule","heulen","streuen","neugier","B√§uerin","H√§user","R√§uber","Z√§une","Kreuz"
];

const WOERTER_EI = [
  "Ei","eins","ein","mein","dein","Bein","Stein","Lein","Reis","Seil",
  "Zeit","weit","klein","fein","rein","frei","bleib","Leim","Heim","Teil",
  "Wein","Pein","Feile","Reihe","Seife","Seite","Kreis","Greif","leise","reisen"
];

/* =========================================================
   DOM
   ========================================================= */
const modeGrid = document.getElementById("mode-grid");
const startScreen = document.getElementById("start-screen");
const quizScreen = document.getElementById("quiz-screen");
const startBtn = document.getElementById("start-btn");
const startInfo = document.getElementById("start-info");

const childNameInput = document.getElementById("child-name");
const loadLastBtn = document.getElementById("load-last-btn");
const resetHistoryBtn = document.getElementById("reset-history-btn");

const filterSelect = document.getElementById("filter-select");
const pauseSelect = document.getElementById("pause-select");
const targetSelect = document.getElementById("target-select");

const voiceSelect = document.getElementById("voice-select");

const whoami = document.getElementById("whoami");
const abortBtn = document.getElementById("abort-btn");

const wordDisplay = document.getElementById("word-display");
const speakBtn = document.getElementById("speak-btn");
const patternInfo = document.getElementById("pattern-info");
const lettersDiv = document.getElementById("letters");
const feedback = document.getElementById("feedback");
const stats = document.getElementById("stats");
const finishBtn = document.getElementById("finish-btn");

const reportWrap = document.getElementById("report");
const reportText = document.getElementById("report-text");
const copyReportBtn = document.getElementById("copy-report");

/* =========================================================
   localStorage Keys
   ========================================================= */
const LS_KEY_LAST_CHILD = "lt_last_child";
const LS_KEY_PREFIX = "lt_history_";
const LS_KEY_VOICE = "lt_voice_uri";

function getChildKey(name){ return LS_KEY_PREFIX + name.trim().toLowerCase(); }

function loadHistory(name){
  const key = getChildKey(name);
  try{
    return JSON.parse(localStorage.getItem(key) || "null") || { child: name, sessions: [] };
  }catch(e){
    return { child:name, sessions:[] };
  }
}
function saveHistory(name, history){
  localStorage.setItem(getChildKey(name), JSON.stringify(history));
}
function resetHistory(name){
  if(!name) return;
  localStorage.removeItem(getChildKey(name));
}

/* =========================================================
   W√∂rter-Quelle (nur diese 3 Listen!)
   ========================================================= */
function buildAllWords(){
  return [
    ...WOERTER_AU.map(w => ({ w, diph: "au" })),
    ...WOERTER_EU.map(w => ({ w, diph: "eu" })),
    ...WOERTER_EI.map(w => ({ w, diph: "ei" }))
  ];
}
function applyFilter(all, filter){
  if(filter === "au") return all.filter(x => x.diph === "au");
  if(filter === "ei") return all.filter(x => x.diph === "ei");
  if(filter === "eu") return all.filter(x => x.diph === "eu");
  return all;
}

/* Diphthong-Beispiele (aus DEINEN Listen) */
const EXAMPLE_FOR = {
  au: "Haus",
  ei: "Seife",
  eu: "Eule"
};

/* =========================================================
   Buchstaben-Checks
   ========================================================= */
function toLowerSafe(s){ return (s || "").toLowerCase(); }
const VOWELS = new Set(["a","e","i","o","u","√§","√∂","√º"]);
const LETTERS = "abcdefghijklmnopqrstuvwxyz√§√∂√º√ü".split("");
function isLetter(ch){ return LETTERS.includes(ch); }
function isVowel(ch){ return VOWELS.has(ch); }
function isConsonant(ch){ return isLetter(ch) && !isVowel(ch); }

function randInt(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }

function makeTemplateAt(word, index, len=1){
  return word.slice(0,index) + "_" + word.slice(index+len);
}
function highlightAt(word, index, len=1, color="#16a34a"){
  const before = word.slice(0,index);
  const mid = word.slice(index, index+len);
  const after = word.slice(index+len);
  return `${before}<span style="color:${color}; font-weight:1000;">${mid}</span>${after}`;
}

/* =========================================================
   Voice / TTS (Browser SpeechSynthesis)
   ========================================================= */
let selectedVoice = null;

function pickBestDefaultVoice(voices){
  // bevorzugt de-DE; oft auf Windows/Edge "Microsoft Katja/Conrad", auf Chrome "Google Deutsch"
  const de = voices.filter(v => (v.lang || "").toLowerCase().startsWith("de"));
  if(!de.length) return voices[0] || null;

  const preferred = [
    "microsoft katja",
    "microsoft conrad",
    "google deutsch",
    "anna",
    "helena",
    "deutsch"
  ];

  for(const key of preferred){
    const v = de.find(x => (x.name || "").toLowerCase().includes(key));
    if(v) return v;
  }
  return de[0];
}

function populateVoices(){
  const voices = speechSynthesis.getVoices();
  voiceSelect.innerHTML = "";

  if(!voices.length){
    const opt = document.createElement("option");
    opt.value = "";
    opt.textContent = "(keine Stimmen gefunden)";
    voiceSelect.appendChild(opt);
    return;
  }

  const storedUri = localStorage.getItem(LS_KEY_VOICE) || "";
  const deSorted = voices
    .slice()
    .sort((a,b)=>{
      const ade = (a.lang||"").toLowerCase().startsWith("de") ? 0 : 1;
      const bde = (b.lang||"").toLowerCase().startsWith("de") ? 0 : 1;
      if(ade !== bde) return ade - bde;
      return (a.name||"").localeCompare(b.name||"");
    });

  deSorted.forEach(v=>{
    const opt = document.createElement("option");
    opt.value = v.voiceURI;
    opt.textContent = `${v.name} (${v.lang})`;
    voiceSelect.appendChild(opt);
  });

  const byUri = (uri)=> voices.find(v => v.voiceURI === uri) || null;

  if(storedUri && byUri(storedUri)){
    voiceSelect.value = storedUri;
    selectedVoice = byUri(storedUri);
  } else {
    selectedVoice = pickBestDefaultVoice(voices);
    if(selectedVoice) voiceSelect.value = selectedVoice.voiceURI;
  }
}

voiceSelect.addEventListener("change", ()=>{
  const uri = voiceSelect.value || "";
  const voices = speechSynthesis.getVoices();
  selectedVoice = voices.find(v => v.voiceURI === uri) || null;
  localStorage.setItem(LS_KEY_VOICE, uri);
  // kurzer Test
  if(selectedVoice){
    speakText("Test");
  }
});

function speakText(text){
  try{ speechSynthesis.cancel(); }catch(e){}
  const u = new SpeechSynthesisUtterance(text);
  u.lang = "de-DE";
  u.rate = 0.78;
  u.pitch = 1.0;
  if(selectedVoice) u.voice = selectedVoice;
  speechSynthesis.speak(u);
}

/* Voices laden (Browsers sind da zickig) */
populateVoices();
if(typeof speechSynthesis !== "undefined"){
  speechSynthesis.onvoiceschanged = populateVoices;
}

/* =========================================================
   Spiel-State
   ========================================================= */
let mode = null;       // start|end|vowel|cons|diph
let session = null;
let current = null;
let freeze = false;

function nowIso(){ return new Date().toISOString(); }

function updateStartState(){
  const nameOk = childNameInput.value.trim().length > 0;
  const modeOk = !!mode;
  startBtn.disabled = !(nameOk && modeOk);

  if(!nameOk && !modeOk) startInfo.textContent = "üë§ Name eingeben + Modus w√§hlen.";
  else if(!nameOk) startInfo.textContent = "üë§ Bitte Name eingeben.";
  else if(!modeOk) startInfo.textContent = "Bitte Modus w√§hlen.";
  else startInfo.textContent = "Bereit. ‚ñ∂Ô∏è Start!";
}

/* Moduswahl */
modeGrid.querySelectorAll(".mode-btn").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    const m = btn.dataset.mode;
    mode = (mode === m) ? null : m;
    modeGrid.querySelectorAll(".mode-btn").forEach(b=>{
      b.classList.toggle("selected", b.dataset.mode === mode);
    });
    updateStartState();
  });
});

childNameInput.addEventListener("input", updateStartState);

loadLastBtn.addEventListener("click", ()=>{
  const last = localStorage.getItem(LS_KEY_LAST_CHILD);
  if(last){
    childNameInput.value = last;
    updateStartState();
  }
});

resetHistoryBtn.addEventListener("click", ()=>{
  const name = childNameInput.value.trim();
  if(!name) return;
  resetHistory(name);
  alert("Diagnose gel√∂scht f√ºr: " + name);
});

/* =========================================================
   Aufgaben erzeugen (3 Buttons)
   ========================================================= */
function make3Options(correct, kind){
  let pool = [];

  if(kind === "diph"){
    pool = ["eu","au","ei"].filter(x => x !== correct);
  } else if(kind === "vowel"){
    // Buttons kindgerecht: nur a/e/i/o/u als Auswahl
    pool = ["a","e","i","o","u"].filter(x => x !== correct);
  } else if(kind === "cons"){
    pool = LETTERS.filter(ch => isConsonant(ch) && ch !== correct);
  } else {
    if(isVowel(correct)) pool = ["a","e","i","o","u"].filter(x => x !== correct);
    else pool = LETTERS.filter(ch => isConsonant(ch) && ch !== correct);
  }

  const raw = [correct];
  while(raw.length < 3 && pool.length){
    const cand = pool.splice(randInt(0,pool.length-1),1)[0];
    if(cand && !raw.includes(cand)) raw.push(cand);
  }

  // Anzeige (kindgerecht mit Symbolen)
  // Diphthong: Button zeigt entweder "au" ODER Beispielwort mit rotem Diphthong.
  const zipped = raw.map(r=>{
    if(kind === "diph"){
      const ex = EXAMPLE_FOR[r];
      const exLower = toLowerSafe(ex);
      const idx = exLower.indexOf(r);
      const exampleHtml = (idx >= 0)
        ? highlightAt(ex, idx, 2, "#dc2626")
        : ex;
      // Karte: oben Symbol + unten Beispiel
      const html = `<span>üß© <span style="letter-spacing:.06em;">${r}</span></span>
                    <span class="btn-sub">${exampleHtml}</span>`;
      return { raw: r, html };
    } else {
      // Buchstaben: sehr einfach, gross
      const shown = (r.length === 1) ? r.toUpperCase() : r;
      const html = `<span>${shown}</span>`;
      return { raw: r, html };
    }
  });

  zipped.sort(()=>Math.random()-0.5);
  return zipped;
}

function renderButtons(zipped){
  lettersDiv.innerHTML = "";
  zipped.forEach(obj=>{
    const btn = document.createElement("button");
    btn.className = "letter-btn";
    btn.dataset.raw = obj.raw;
    btn.innerHTML = obj.html; // HTML n√∂tig f√ºr rote Buchstaben im Beispiel
    btn.onclick = () => {
      if(freeze) return;
      handleChoice(obj.raw, btn);
    };
    lettersDiv.appendChild(btn);
  });
}

function pickIndexFor(wordLower, want){
  const idxs = [];
  for(let i=0;i<wordLower.length;i++){
    const ch = wordLower[i];
    if(want === "vowel" && isVowel(ch)) idxs.push(i);
    if(want === "cons" && isConsonant(ch)) idxs.push(i);
  }
  if(!idxs.length) return -1;
  return idxs[randInt(0, idxs.length-1)];
}

function buildTask(allWordsFiltered){
  const item = allWordsFiltered[randInt(0, allWordsFiltered.length-1)];
  const word = item.w;
  const lower = toLowerSafe(word);

  if(mode === "diph"){
    const diph = item.diph; // au/ei/eu
    const idx = lower.indexOf(diph);
    if(idx < 0) return null;
    return {
      word, lower,
      correct: diph,
      idx, len: 2,
      kind: "diph",
      template: makeTemplateAt(word, idx, 2),
      info: "W√§hle: eu / au / ei"
    };
  }

  if(mode === "start"){
    const correct = lower[0];
    return {
      word, lower,
      correct,
      idx: 0, len: 1,
      kind: "letter",
      template: makeTemplateAt(word, 0, 1),
      info: "W√§hle den Anfang."
    };
  }

  if(mode === "end"){
    const idx = lower.length - 1;
    const correct = lower[idx];
    return {
      word, lower,
      correct,
      idx, len: 1,
      kind: "letter",
      template: makeTemplateAt(word, idx, 1),
      info: "W√§hle das Ende."
    };
  }

  if(mode === "vowel"){
    const idx = pickIndexFor(lower, "vowel");
    if(idx < 0) return null;
    const correct = lower[idx];
    return {
      word, lower,
      correct,
      idx, len: 1,
      kind: "vowel",
      template: makeTemplateAt(word, idx, 1),
      info: "W√§hle den Vokal."
    };
  }

  if(mode === "cons"){
    const idx = pickIndexFor(lower, "cons");
    if(idx < 0) return null;
    const correct = lower[idx];
    return {
      word, lower,
      correct,
      idx, len: 1,
      kind: "cons",
      template: makeTemplateAt(word, idx, 1),
      info: "W√§hle den Konsonant."
    };
  }

  return null;
}

/* =========================================================
   Start / Loop
   ========================================================= */
startBtn.addEventListener("click", ()=>{
  const child = childNameInput.value.trim();
  if(!child || !mode) return;

  localStorage.setItem(LS_KEY_LAST_CHILD, child);

  const target = parseInt(targetSelect.value, 10) || 20;
  const pauseMs = parseInt(pauseSelect.value, 10) || 20000;
  const filter = filterSelect.value || "all";

  session = {
    session_id: (crypto?.randomUUID?.() || String(Date.now())),
    started_at: nowIso(),
    child,
    mode,
    filter,
    pause_ms: pauseMs,
    target_correct: target,
    correct: 0,
    wrong_total: 0,
    wrong_by_button: {},
    wrong_by_word: {},
    items: [] // {ts, word, template, correct, chosen, ok}
  };

  // UI
  whoami.textContent = "üë§ Kind: " + child;
  reportWrap.classList.add("hidden");
  finishBtn.classList.add("hidden");
  finishBtn.disabled = false;

  startScreen.classList.add("hidden");
  quizScreen.classList.remove("hidden");

  stats.textContent = `‚úÖ Richtig: 0 / ${target}`;
  feedback.textContent = "";
  feedback.className = "feedback";

  nextItem();
});

abortBtn.addEventListener("click", ()=> endSession(false));

function nextItem(){
  freeze = false;
  feedback.textContent = "";
  feedback.className = "feedback";

  const all = applyFilter(buildAllWords(), session.filter);

  let tries = 0;
  let task = null;
  while(tries < 120 && !task){
    task = buildTask(all);
    tries++;
  }
  if(!task){
    endSession(false);
    return;
  }

  current = task;
  wordDisplay.textContent = current.template;
  patternInfo.textContent = current.info;

  // Vorlesen
  speakText(current.word);

  // Buttons (immer 3)
  renderButtons(make3Options(current.correct, current.kind));
}

speakBtn.onclick = ()=>{
  if(!current) return;
  speakText(current.word);
};

function handleChoice(chosen, btn){
  if(!current || freeze) return;

  const ok = (chosen === current.correct);

  session.items.push({
    ts: nowIso(),
    word: current.word,
    template: current.template,
    correct: current.correct,
    chosen,
    ok
  });

  if(ok){
    session.correct++;
    feedback.textContent = "‚úÖ Richtig!";
    feedback.classList.add("ok");

    Array.from(lettersDiv.querySelectorAll("button")).forEach(b=>b.disabled=true);
    freeze = true;

    wordDisplay.innerHTML = highlightAt(current.word, current.idx, current.len, "#16a34a");
    speakText(current.word);

    stats.textContent = `‚úÖ Richtig: ${session.correct} / ${session.target_correct}`;

    if(session.correct >= session.target_correct){
      setTimeout(()=> endSession(true), session.pause_ms);
    } else {
      setTimeout(()=> nextItem(), session.pause_ms);
    }
  } else {
    session.wrong_total++;
    session.wrong_by_button[chosen] = (session.wrong_by_button[chosen] || 0) + 1;
    session.wrong_by_word[current.word] = (session.wrong_by_word[current.word] || 0) + 1;

    feedback.textContent = "‚ùå Nochmals!";
    feedback.classList.remove("ok");
    feedback.classList.add("err");

    // falscher Button verschwindet
    btn.remove();
  }
}

/* =========================================================
   Ende + Report (nur Text zum Kopieren)
   ========================================================= */
function topN(obj, n){
  const arr = Object.entries(obj || {}).sort((a,b)=>b[1]-a[1]);
  return arr.slice(0,n);
}

function buildReportText(completed){
  const lines = [];
  lines.push("LESEN / LUECKEN-TRAINING ‚Äì REPORT");
  lines.push("--------------------------------");
  lines.push(`Kind: ${session.child}`);
  lines.push(`Datum: ${new Date().toLocaleString("de-CH")}`);
  lines.push(`Modus: ${session.mode}`);
  lines.push(`Filter: ${session.filter}`);
  lines.push(`Ziel: ${session.target_correct}`);
  lines.push(`Richtig: ${session.correct}`);
  lines.push(`Fehler: ${session.wrong_total}`);
  lines.push("");

  lines.push("Haeufige falsche Buttons:");
  const topBtn = topN(session.wrong_by_button, 10);
  if(!topBtn.length) lines.push("  (keine)");
  else topBtn.forEach(([k,v])=>lines.push(`  - ${k}: ${v}`));
  lines.push("");

  lines.push("Haeufige Fehler-Woerter:");
  const topW = topN(session.wrong_by_word, 10);
  if(!topW.length) lines.push("  (keine)");
  else topW.forEach(([k,v])=>lines.push(`  - ${k}: ${v}`));
  lines.push("");

  lines.push("Detail (letzte 30 Versuche):");
  const last = session.items.slice(-30);
  last.forEach(it=>{
    lines.push(`  ${it.ok ? "OK " : "NO "}  Wort: ${it.word} | Luecke: ${it.template} | korrekt: ${it.correct} | gewaehlt: ${it.chosen}`);
  });
  lines.push("");

  lines.push("Hinweis:");
  lines.push(completed
    ? "  Spiel erfolgreich beendet. (LearningView: AppSolved wird gesendet)"
    : "  Spiel beendet ohne Erfolg. (Kein AppSolved)");
  return lines.join("\n");
}

function endSession(completed){
  freeze = true;
  lettersDiv.innerHTML = "";
  patternInfo.textContent = "";

  // History speichern
  const history = loadHistory(session.child);
  history.child = session.child;
  history.sessions.push({ ...session, ended_at: nowIso(), completed });
  saveHistory(session.child, history);

  if(completed){
    feedback.textContent = "üéâ Super!";
    feedback.classList.remove("err");
    feedback.classList.add("ok");
    wordDisplay.textContent = "Fertig!";
    finishBtn.classList.remove("hidden");
    finishBtn.disabled = false;

    finishBtn.onclick = ()=>{
      finishBtn.disabled = true;
      try{
        if(window.parent && window.parent !== window){
          window.parent.postMessage("AppSolved","*");
        }
      }catch(e){}
      showReport(completed);
    };
  } else {
    feedback.textContent = "‚èπ Beendet.";
    feedback.classList.remove("ok");
    feedback.classList.add("err");
    wordDisplay.textContent = "Bis bald!";
    showReport(completed);
  }
}

function showReport(completed){
  reportWrap.classList.remove("hidden");
  const txt = buildReportText(completed);
  reportText.value = txt;
  reportText.scrollTop = 0;
}

copyReportBtn.onclick = async ()=>{
  try{
    await navigator.clipboard.writeText(reportText.value || "");
    alert("Report kopiert.");
  }catch(e){
    alert("Kopieren nicht m√∂glich. Markiere den Text und kopiere manuell.");
  }
};

/* Init */
setTimeout(()=> speakText("H√∂r gut zu."), 650);
updateStartState();
</script>
</body>
</html>
