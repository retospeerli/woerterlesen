<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Lesetraining ‚Äì L√ºcken f√ºllen (au/ei/eu)</title>
<style>
  :root{
    font-family: "Comic Sans MS","Segoe UI",system-ui,sans-serif;
    background: radial-gradient(1200px 600px at 15% 10%, #eef2ff 0%, #fdf2f8 42%, #ecfeff 100%);
  }
  body{
    margin:0;
    min-height:100vh;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:18px;
    box-sizing:border-box;
  }
  .app{
    background: rgba(255,255,255,0.92);
    backdrop-filter: blur(6px);
    border: 1px solid rgba(199,210,254,0.8);
    border-radius: 20px;
    box-shadow: 0 14px 40px rgba(0,0,0,0.10);
    padding: 1.7rem 2rem;
    max-width: 860px;
    width: 100%;
    box-sizing:border-box;
  }

  header{
    display:flex;
    gap:12px;
    align-items:center;
    justify-content:space-between;
    flex-wrap:wrap;
    margin-bottom:.6rem;
  }
  h1{ margin:0; font-size:1.65rem; }
  .subtitle{ margin:.2rem 0 1rem 0; color:#4b5563; line-height:1.35; }

  .card{
    background: rgba(255,255,255,0.85);
    border: 1px solid rgba(199,210,254,0.7);
    border-radius: 16px;
    padding: 14px;
    box-shadow: 0 10px 26px rgba(0,0,0,0.06);
  }

  .hidden{ display:none; }
  .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
  .row > *{ flex: 0 0 auto; }

  label{ font-weight:800; color:#374151; }
  input[type="text"]{
    padding:.65rem .8rem;
    border-radius: 12px;
    border: 2px solid #c7d2fe;
    outline:none;
    font-weight:800;
    min-width: 210px;
  }

  .mode-grid{
    display:grid;
    grid-template-columns: repeat(2, minmax(0,1fr));
    gap:.6rem;
    margin:.75rem 0 .5rem 0;
  }
  @media (min-width: 820px){
    .mode-grid{ grid-template-columns: repeat(5, minmax(0,1fr)); }
  }

  .mode-btn{
    padding: .8rem .65rem;
    border-radius: 16px;
    border: 2px solid #d1d5db;
    background: linear-gradient(180deg, #ffffff 0%, #f9fafb 100%);
    font-size: .92rem;
    font-weight: 900;
    cursor:pointer;
    transition: transform .05s ease, box-shadow .15s ease, border-color .15s ease;
  }
  .mode-btn:hover{
    border-color:#a5b4fc;
    box-shadow: 0 8px 22px rgba(99,102,241,0.12);
  }
  .mode-btn.selected{
    border-color:#4f46e5;
    background: linear-gradient(180deg, #4f46e5 0%, #2563eb 100%);
    color:#fff;
    box-shadow: 0 10px 26px rgba(37,99,235,0.30);
  }
  .mode-btn:active{ transform: translateY(1px); }

  .pill{
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding:.55rem .7rem;
    border-radius:999px;
    border: 2px solid #c7d2fe;
    background:#eef2ff;
    font-weight:900;
  }
  .pill select{
    border:none;
    background:transparent;
    font-weight:900;
    cursor:pointer;
    outline:none;
  }

  .primary-btn{
    padding:.75rem 1.1rem;
    font-size:1.02rem;
    border-radius:999px;
    border:none;
    cursor:pointer;
    background: linear-gradient(180deg, #2563eb 0%, #1d4ed8 100%);
    color:#fff;
    font-weight:900;
    box-shadow: 0 10px 22px rgba(37,99,235,0.22);
    transition: transform .05s ease, filter .15s ease;
  }
  .primary-btn:hover{ filter: brightness(1.03); }
  .primary-btn:active{ transform: translateY(1px); }
  .primary-btn:disabled{ background:#9ca3af; box-shadow:none; cursor:not-allowed; }

  .ghost-btn{
    padding:.72rem 1rem;
    font-size:1rem;
    border-radius:999px;
    border: 2px solid #c7d2fe;
    background:#ffffff;
    cursor:pointer;
    font-weight:900;
  }
  .ghost-btn:hover{ background:#eef2ff; }

  .danger-btn{
    padding:.72rem 1rem;
    font-size:1rem;
    border-radius:999px;
    border: 2px solid #fecaca;
    background:#fff;
    cursor:pointer;
    font-weight:900;
  }
  .danger-btn:hover{ background:#fef2f2; }

  /* Quiz */
  .quiz{
    text-align:center;
    margin-top: 10px;
  }
  .word{
    font-family: "Comic Sans MS", sans-serif;
    font-size: 3.05rem;
    letter-spacing: 0.16em;
    margin: .7rem 0 .45rem;
    user-select:none;
  }
  .pattern-info{
    font-size: .98rem;
    color:#6b7280;
    margin-bottom:.7rem;
    font-weight:800;
  }
  #speak-btn{
    padding:.62rem 1rem;
    font-size:1rem;
    border-radius:14px;
    cursor:pointer;
    border: 2px solid #c7d2fe;
    background: #eef2ff;
    margin-bottom:.55rem;
    font-weight:900;
  }
  #speak-btn:hover{ background:#e0e7ff; }

  .letters{
    margin-top: .85rem;
    display:grid;
    grid-template-columns: repeat(3, 1fr);
    gap:.65rem;
    max-width: 520px;
    margin-left:auto;
    margin-right:auto;
  }
  .letter-btn{
    font-family: "Comic Sans MS", sans-serif;
    padding: .85rem .6rem;
    border-radius: 14px;
    background: linear-gradient(180deg, #e0f2fe 0%, #e0e7ff 100%);
    border: 2px solid #c7d2fe;
    cursor:pointer;
    font-size: 1.55rem;
    font-weight: 900;
  }
  .letter-btn:hover{ filter: brightness(1.03); }
  .letter-btn:disabled{ opacity:.55; cursor:default; }

  .feedback{
    min-height:1.6rem;
    font-size:1.2rem;
    margin-top:.85rem;
    font-weight:1000;
  }
  .ok{ color:#15803d; }
  .err{ color:#b91c1c; }

  .stats{
    margin-top:.3rem;
    font-size:.95rem;
    color:#374151;
    font-weight:900;
  }

  .report{
    margin-top: 10px;
    text-align:left;
  }
  .report h2{ margin:.2rem 0 .6rem 0; font-size:1.15rem; }
  .small{
    color:#6b7280;
    font-weight:800;
    font-size:.92rem;
    line-height:1.35;
  }
  pre{
    white-space: pre-wrap;
    word-break: break-word;
    background:#0b1220;
    color:#e5e7eb;
    padding: 12px;
    border-radius: 14px;
    border: 1px solid rgba(199,210,254,0.2);
    max-height: 280px;
    overflow:auto;
    font-size:.9rem;
  }
</style>
</head>

<body>
<div class="app">
  <header>
    <div>
      <h1>Lesetraining (au / ei / eu)</h1>
      <div class="subtitle">H√∂r zu, f√ºlle die L√ºcke und w√§hle die richtige L√∂sung (immer 3 Buttons).</div>
    </div>
    <div class="row">
      <span class="pill">
        <span>Filter:</span>
        <select id="filter-select" aria-label="Filter">
          <option value="all">au + ei + eu</option>
          <option value="au">nur au</option>
          <option value="ei">nur ei</option>
          <option value="eu">nur eu</option>
        </select>
      </span>

      <span class="pill">
        <span>Pause:</span>
        <select id="pause-select" aria-label="Pause">
          <option value="15000">15s</option>
          <option value="20000" selected>20s</option>
          <option value="30000">30s</option>
        </select>
      </span>

      <span class="pill">
        <span>Ziel:</span>
        <select id="target-select" aria-label="Ziel richtig">
          <option value="10">10</option>
          <option value="20" selected>20</option>
          <option value="30">30</option>
        </select>
      </span>
    </div>
  </header>

  <!-- START -->
  <div id="start-screen" class="card">
    <div class="row" style="justify-content:space-between;">
      <div class="row">
        <label for="child-name">Name:</label>
        <input id="child-name" type="text" placeholder="z.B. Mia" maxlength="24" />
      </div>
      <div class="row">
        <button id="load-last-btn" class="ghost-btn" type="button">Letztes Kind laden</button>
      </div>
    </div>

    <div class="mode-grid" id="mode-grid" style="margin-top:12px;">
      <button type="button" class="mode-btn" data-mode="start">1) Anfang</button>
      <button type="button" class="mode-btn" data-mode="end">2) Ende</button>
      <button type="button" class="mode-btn" data-mode="vowel">3) Vokale</button>
      <button type="button" class="mode-btn" data-mode="cons">4) Konson.</button>
      <button type="button" class="mode-btn" data-mode="diph">5) Diphth.</button>
    </div>

    <div class="small" id="start-info">Bitte Name eintragen und Modus w√§hlen.</div>

    <div class="row" style="margin-top:10px;">
      <button id="start-btn" class="primary-btn" disabled type="button">Los geht's!</button>
      <button id="reset-history-btn" class="danger-btn" type="button">Diagnose l√∂schen</button>
    </div>

    <div class="small" style="margin-top:10px;">
      Diagnose: Fehler werden pro Kind gespeichert (localStorage). Export als JSON/CSV am Ende.
    </div>
  </div>

  <!-- QUIZ -->
  <div id="quiz-screen" class="card hidden">
    <div class="row" style="justify-content:space-between;">
      <div class="small" id="whoami">Kind: ‚Äì</div>
      <div class="row">
        <button id="abort-btn" class="danger-btn" type="button">Spiel beenden</button>
      </div>
    </div>

    <div class="quiz">
      <div class="word" id="word-display">_</div>
      <button id="speak-btn" type="button">üîä Noch einmal h√∂ren</button>
      <div class="pattern-info" id="pattern-info"></div>

      <div class="letters" id="letters"></div>

      <div class="feedback" id="feedback"></div>
      <div class="stats" id="stats"></div>

      <button id="finish-btn" class="hidden primary-btn" type="button">Fertig ‚úî</button>
    </div>

    <!-- REPORT -->
    <div id="report" class="report hidden">
      <h2>Report & Export</h2>
      <div class="row" style="margin-bottom:8px;">
        <button id="download-json" class="ghost-btn" type="button">JSON herunterladen</button>
        <button id="download-csv" class="ghost-btn" type="button">CSV herunterladen</button>
        <button id="copy-json" class="ghost-btn" type="button">JSON kopieren</button>
      </div>
      <div class="small">Vorschau:</div>
      <pre id="report-preview"></pre>
    </div>
  </div>
</div>

<script>
/* =========================================================
   WORTLISTEN: NUR aus dem Chat (unver√§ndert)
   ========================================================= */

const WOERTER_AU = [
  "Auto","Auge","auch","aus","auf","Haus","Maus","Baum","Zaun","Bauch",
  "Faust","Pause","Kauf","laut","Laub","Tau","Sau","Haut","Sauer","Traum",
  "Raum","Kraut","Staub","brauch","laufen","kaufen","tauchen","bauen","saufen","raufen"
];

const WOERTER_EU = [
  "Eule","heute","Feuer","neun","neu","Leute","Beute","Freund","freuen","treu",
  "Zeug","Teufel","euern","keusch","Heu","Euro","Reue","Scheu","deuten","leuchten",
  "Beule","Keule","heulen","streuen","neugier","B√§uerin","H√§user","R√§uber","Z√§une","Kreuz"
];

const WOERTER_EI = [
  "Ei","eins","ein","mein","dein","Bein","Stein","Lein","Reis","Seil",
  "Zeit","weit","klein","fein","rein","frei","bleib","Leim","Heim","Teil",
  "Wein","Pein","Feile","Reihe","Seife","Seite","Kreis","Greif","leise","reisen"
];

/* =========================================================
   APP-SETUP
   ========================================================= */

const DEFAULT_TARGET = 20;

const modeGrid = document.getElementById("mode-grid");
const startScreen = document.getElementById("start-screen");
const quizScreen = document.getElementById("quiz-screen");
const startBtn = document.getElementById("start-btn");
const startInfo = document.getElementById("start-info");

const childNameInput = document.getElementById("child-name");
const loadLastBtn = document.getElementById("load-last-btn");
const resetHistoryBtn = document.getElementById("reset-history-btn");

const filterSelect = document.getElementById("filter-select");
const pauseSelect = document.getElementById("pause-select");
const targetSelect = document.getElementById("target-select");

const whoami = document.getElementById("whoami");
const abortBtn = document.getElementById("abort-btn");

const wordDisplay = document.getElementById("word-display");
const speakBtn = document.getElementById("speak-btn");
const patternInfo = document.getElementById("pattern-info");
const lettersDiv = document.getElementById("letters");
const feedback = document.getElementById("feedback");
const stats = document.getElementById("stats");
const finishBtn = document.getElementById("finish-btn");

const reportWrap = document.getElementById("report");
const reportPreview = document.getElementById("report-preview");
const downloadJsonBtn = document.getElementById("download-json");
const downloadCsvBtn = document.getElementById("download-csv");
const copyJsonBtn = document.getElementById("copy-json");

/* =========================================================
   Diagnose (localStorage)
   ========================================================= */

const LS_KEY_LAST_CHILD = "lt_last_child";
const LS_KEY_PREFIX = "lt_history_"; // + childName

function getChildKey(name){
  return LS_KEY_PREFIX + name.trim().toLowerCase();
}

function loadHistory(name){
  const key = getChildKey(name);
  try{
    return JSON.parse(localStorage.getItem(key) || "null") || {
      child: name,
      sessions: []
    };
  }catch(e){
    return { child:name, sessions:[] };
  }
}

function saveHistory(name, history){
  const key = getChildKey(name);
  localStorage.setItem(key, JSON.stringify(history));
}

function resetHistory(name){
  if(!name) return;
  localStorage.removeItem(getChildKey(name));
}

/* =========================================================
   W√∂rter-Quelle (nur diese 3 Listen!)
   ========================================================= */

function buildAllWords(){
  const all = [
    ...WOERTER_AU.map(w => ({ w, diph: "au" })),
    ...WOERTER_EU.map(w => ({ w, diph: "eu" })),
    ...WOERTER_EI.map(w => ({ w, diph: "ei" }))
  ];
  return all;
}

function applyFilter(all, filter){
  if(filter === "au") return all.filter(x => x.diph === "au");
  if(filter === "ei") return all.filter(x => x.diph === "ei");
  if(filter === "eu") return all.filter(x => x.diph === "eu");
  return all;
}

/* =========================================================
   Spiel-State
   ========================================================= */

let mode = null;                 // start|end|vowel|cons|diph
let session = null;              // aktuelle Sessiondaten
let current = null;              // aktuelle Aufgabe
let freeze = false;

function nowIso(){
  return new Date().toISOString();
}

function isNounByCasing(word){
  // Keine neuen Daten erlaubt -> Heuristik: Gross am Anfang => Nomen (oder Eigennamen/Anfang).
  // Nutzt nur die vorhandenen Wort-Strings.
  return /^[A-Z√Ñ√ñ√ú]/.test(word);
}

/* Vokale: inkl. Umlautvokale (wegen B√§uerin/H√§user/R√§uber/Z√§une) */
const VOWELS = new Set(["a","e","i","o","u","√§","√∂","√º"]);
const LETTERS = "abcdefghijklmnopqrstuvwxyz√§√∂√º√ü".split("");

function toLowerSafe(s){ return (s || "").toLowerCase(); }

function isLetter(ch){
  return LETTERS.includes(ch);
}

function isVowel(ch){
  return VOWELS.has(ch);
}

function isConsonant(ch){
  return isLetter(ch) && !isVowel(ch);
}

/* =========================================================
   Speech (KI im Browser)
   ========================================================= */

function speak(text){
  try{ speechSynthesis.cancel(); }catch(e){}
  const u = new SpeechSynthesisUtterance(text);
  u.lang = "de-DE";
  u.rate = 0.78;
  speechSynthesis.speak(u);
}

/* =========================================================
   Aufgaben erzeugen (immer 3 Buttons)
   ========================================================= */

function randInt(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }

function makeTemplateAt(word, index, len=1){
  return word.slice(0,index) + "_" + word.slice(index+len);
}

function highlightAt(word, index, len=1){
  const before = word.slice(0,index);
  const mid = word.slice(index, index+len);
  const after = word.slice(index+len);
  return `${before}<span style="color:#16a34a;">${mid}</span>${after}`;
}

function make3Options(correct, kind, nounUpper=false){
  // kind: "diph" | "vowel" | "cons" | "letter"
  let pool = [];

  if(kind === "diph"){
    pool = ["au","ei","eu"].filter(x => x !== correct);
  } else if(kind === "vowel"){
    pool = ["a","e","i","o","u"].filter(x => x !== correct); // Buttons ohne Umlaute (kindgerechter)
  } else if(kind === "cons"){
    pool = LETTERS.filter(ch => isConsonant(ch) && ch !== correct);
  } else {
    if(isVowel(correct)){
      pool = ["a","e","i","o","u"].filter(x => x !== correct);
    }else{
      pool = LETTERS.filter(ch => isConsonant(ch) && ch !== correct);
    }
  }

  const raw = [correct];
  while(raw.length < 3 && pool.length){
    const cand = pool.splice(randInt(0,pool.length-1),1)[0];
    if(cand && !raw.includes(cand)) raw.push(cand);
  }

  // Anzeige
  const shown = raw.map(x => {
    if(!nounUpper) return x;
    return (x.length === 1) ? x.toUpperCase() : x; // Diphthong bleibt klein
  });

  const zipped = shown.map((s,i)=>({ shown:s, raw: raw[i] }));
  zipped.sort(()=>Math.random()-0.5);
  return zipped;
}

function renderButtons(zipped){
  lettersDiv.innerHTML = "";
  zipped.forEach(obj=>{
    const btn = document.createElement("button");
    btn.className = "letter-btn";
    btn.textContent = obj.shown;
    btn.dataset.raw = obj.raw;
    btn.onclick = () => {
      if(freeze) return;
      handleChoice(obj.raw, btn);
    };
    lettersDiv.appendChild(btn);
  });
}

function pickIndexFor(wordLower, want){
  const idxs = [];
  for(let i=0;i<wordLower.length;i++){
    const ch = wordLower[i];
    if(want === "vowel" && isVowel(ch)) idxs.push(i);
    if(want === "cons" && isConsonant(ch)) idxs.push(i);
  }
  if(!idxs.length) return -1;
  return idxs[randInt(0, idxs.length-1)];
}

function buildTask(allWordsFiltered){
  const item = allWordsFiltered[randInt(0, allWordsFiltered.length-1)];
  const word = item.w;              // Original (Gross/Klein + Umlaute)
  const lower = toLowerSafe(word);
  const noun = isNounByCasing(word);

  if(mode === "diph"){
    const diph = item.diph;         // au/ei/eu
    const idx = lower.indexOf(diph);
    if(idx < 0) return null;

    return {
      word,
      lower,
      correct: diph,
      idx,
      len: 2,
      kind: "diph",
      nounUpper: false,
      template: makeTemplateAt(word, idx, 2),
      info: "W√§hle den richtigen Diphthong (au / ei / eu)."
    };
  }

  if(mode === "start"){
    const correct = lower[0];
    return {
      word,
      lower,
      correct,
      idx: 0,
      len: 1,
      kind: "letter",
      nounUpper: noun, // Nomen: Buttons gross
      template: makeTemplateAt(word, 0, 1),
      info: "W√§hle den Anfangsbuchstaben."
    };
  }

  if(mode === "end"){
    const idx = lower.length - 1;
    const correct = lower[idx];
    return {
      word,
      lower,
      correct,
      idx,
      len: 1,
      kind: "letter",
      nounUpper: noun, // Nomen: Buttons gross
      template: makeTemplateAt(word, idx, 1),
      info: "W√§hle den Endbuchstaben."
    };
  }

  if(mode === "vowel"){
    const idx = pickIndexFor(lower, "vowel");
    if(idx < 0) return null;
    const correct = lower[idx];
    // Wenn Umlaut im Wort vorkommt, bleibt korrekter Umlaut korrekt (Button-Pool ohne Umlaut kann dann zu kurz sein)
    // -> wir zeigen im Button korrekt "√§/√∂/√º" falls Ziel so ist; Distraktoren bleiben a/e/i/o/u.
    return {
      word,
      lower,
      correct,
      idx,
      len: 1,
      kind: "vowel",
      nounUpper: false,
      template: makeTemplateAt(word, idx, 1),
      info: "W√§hle den richtigen Vokal."
    };
  }

  if(mode === "cons"){
    const idx = pickIndexFor(lower, "cons");
    if(idx < 0) return null;
    const correct = lower[idx];
    return {
      word,
      lower,
      correct,
      idx,
      len: 1,
      kind: "cons",
      nounUpper: false,
      template: makeTemplateAt(word, idx, 1),
      info: "W√§hle den richtigen Konsonanten."
    };
  }

  return null;
}

/* =========================================================
   Flow
   ========================================================= */

function updateStartState(){
  const nameOk = childNameInput.value.trim().length > 0;
  const modeOk = !!mode;
  startBtn.disabled = !(nameOk && modeOk);

  if(!nameOk && !modeOk) startInfo.textContent = "Bitte Name eintragen und Modus w√§hlen.";
  else if(!nameOk) startInfo.textContent = "Bitte Name eintragen.";
  else if(!modeOk) startInfo.textContent = "Bitte Modus w√§hlen.";
  else startInfo.textContent = "Startbereit. Viel Erfolg!";
}

modeGrid.querySelectorAll(".mode-btn").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    const m = btn.dataset.mode;
    mode = (mode === m) ? null : m;
    modeGrid.querySelectorAll(".mode-btn").forEach(b=>{
      b.classList.toggle("selected", b.dataset.mode === mode);
    });
    updateStartState();
  });
});

childNameInput.addEventListener("input", updateStartState);
filterSelect.addEventListener("change", ()=>{ /* wirkt ab n√§chster Aufgabe */ });
pauseSelect.addEventListener("change", ()=>{ /* wirkt ab n√§chster Aufgabe */ });
targetSelect.addEventListener("change", ()=>{ /* wirkt ab n√§chster Aufgabe */ });

loadLastBtn.addEventListener("click", ()=>{
  const last = localStorage.getItem(LS_KEY_LAST_CHILD);
  if(last){
    childNameInput.value = last;
    updateStartState();
  }
});

resetHistoryBtn.addEventListener("click", ()=>{
  const name = childNameInput.value.trim();
  if(!name) return;
  resetHistory(name);
  alert("Diagnose gel√∂scht f√ºr: " + name);
});

startBtn.addEventListener("click", ()=>{
  const child = childNameInput.value.trim();
  if(!child || !mode) return;

  localStorage.setItem(LS_KEY_LAST_CHILD, child);

  const target = parseInt(targetSelect.value, 10) || DEFAULT_TARGET;
  const pauseMs = parseInt(pauseSelect.value, 10) || 20000;
  const filter = filterSelect.value || "all";

  session = {
    session_id: crypto?.randomUUID?.() || String(Date.now()),
    started_at: nowIso(),
    child,
    mode,
    filter,
    pause_ms: pauseMs,
    target_correct: target,
    correct: 0,
    wrong_total: 0,
    wrong_by_button: {},
    wrong_by_word: {},
    items: [] // {word, template, correct, chosen, ok, ts}
  };

  // UI
  whoami.textContent = "Kind: " + child;
  reportWrap.classList.add("hidden");
  finishBtn.classList.add("hidden");
  finishBtn.disabled = false;

  startScreen.classList.add("hidden");
  quizScreen.classList.remove("hidden");

  stats.textContent = `Richtige W√∂rter: 0 / ${target}`;
  feedback.textContent = "";
  feedback.className = "feedback";

  nextItem();
});

abortBtn.addEventListener("click", ()=>{
  // Spiel beenden ohne AppSolved
  endSession(false);
});

/* =========================================================
   Item-Loop
   ========================================================= */

function nextItem(){
  freeze = false;
  feedback.textContent = "";
  feedback.className = "feedback";

  const filter = session?.filter || "all";
  const all = applyFilter(buildAllWords(), filter);

  // Sicherheits-Schleife, falls selten keine passenden Indizes (z.B. sehr kurze W√∂rter)
  let tries = 0;
  let task = null;
  while(tries < 80 && !task){
    task = buildTask(all);
    tries++;
  }
  if(!task){
    // Notfall: beende Session
    endSession(false);
    return;
  }

  current = task;

  wordDisplay.textContent = current.template;
  patternInfo.textContent = current.info;

  // vorlesen
  speak(current.word);

  // Buttons
  const opts = make3Options(current.correct, current.kind, current.nounUpper);
  renderButtons(opts);
}

speakBtn.onclick = ()=>{
  if(!current) return;
  speak(current.word);
};

function handleChoice(chosen, btn){
  if(!current || freeze) return;

  const ok = (chosen === current.correct);

  // Log item
  session.items.push({
    ts: nowIso(),
    word: current.word,
    template: current.template,
    correct: current.correct,
    chosen,
    ok
  });

  if(ok){
    session.correct++;
    feedback.textContent = "Richtig! üëç Lies das Wort.";
    feedback.classList.add("ok");

    // Buttons sperren
    Array.from(lettersDiv.querySelectorAll("button")).forEach(b=>b.disabled=true);
    freeze = true;

    // Gr√ºn einblenden
    wordDisplay.innerHTML = highlightAt(current.word, current.idx, current.len);

    // Wort nochmal vorlesen
    speak(current.word);

    const target = session.target_correct;
    stats.textContent = `Richtige W√∂rter: ${session.correct} / ${target}`;

    const pauseMs = session.pause_ms || 20000;

    if(session.correct >= target){
      setTimeout(()=> endSession(true), pauseMs);
    }else{
      setTimeout(()=> nextItem(), pauseMs);
    }
  }else{
    session.wrong_total++;

    // Diagnose: falscher Button
    session.wrong_by_button[chosen] = (session.wrong_by_button[chosen] || 0) + 1;

    // Diagnose: Wort
    session.wrong_by_word[current.word] = (session.wrong_by_word[current.word] || 0) + 1;

    feedback.textContent = "Versuch es noch einmal.";
    feedback.classList.remove("ok");
    feedback.classList.add("err");

    // Falscher Button verschwindet (Feature beibehalten)
    btn.remove();
  }
}

/* =========================================================
   Session-Ende + Export + LearningView
   ========================================================= */

function buildExportObject(completed){
  const endedAt = nowIso();
  const exportObj = {
    ...session,
    ended_at: endedAt,
    completed
  };
  return exportObj;
}

function updateHistoryWithSession(child, exportObj){
  const history = loadHistory(child);
  history.child = child;
  history.sessions.push(exportObj);
  saveHistory(child, history);
}

function toCSV(exportObj){
  // Pro Item eine Zeile
  const header = ["ts","child","mode","filter","word","template","correct","chosen","ok"].join(",");
  const rows = exportObj.items.map(it => [
    it.ts,
    safeCsv(exportObj.child),
    exportObj.mode,
    exportObj.filter,
    safeCsv(it.word),
    safeCsv(it.template),
    safeCsv(it.correct),
    safeCsv(it.chosen),
    it.ok ? "1" : "0"
  ].join(","));
  return [header, ...rows].join("\n");
}

function safeCsv(v){
  const s = String(v ?? "");
  if(/[",\n]/.test(s)){
    return `"${s.replaceAll('"','""')}"`;
  }
  return s;
}

function downloadText(filename, text, mime){
  const blob = new Blob([text], { type: mime || "text/plain;charset=utf-8" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=> URL.revokeObjectURL(url), 500);
}

function endSession(completed){
  freeze = true;
  lettersDiv.innerHTML = "";
  patternInfo.textContent = "";

  const exportObj = buildExportObject(completed);
  updateHistoryWithSession(exportObj.child, exportObj);

  if(completed){
    feedback.textContent = "Super gemacht! üéâ";
    feedback.classList.remove("err");
    feedback.classList.add("ok");
    wordDisplay.textContent = "Toll gearbeitet!";

    finishBtn.classList.remove("hidden");
    finishBtn.disabled = false;
    finishBtn.textContent = "Fertig ‚úî";

    finishBtn.onclick = ()=>{
      finishBtn.disabled = true;
      finishBtn.textContent = "Erledigt ‚úî";
      // LearningView Feedback NUR bei completed
      try{
        if(window.parent && window.parent !== window){
          window.parent.postMessage("AppSolved","*");
        }
      }catch(e){
        console.warn("LearningView-AppSolved nicht m√∂glich:", e);
      }
      showReport(exportObj);
    };
  }else{
    feedback.textContent = "Spiel beendet.";
    feedback.classList.remove("ok");
    feedback.classList.add("err");
    wordDisplay.textContent = "Bis bald!";
    showReport(exportObj);
  }
}

function showReport(exportObj){
  reportWrap.classList.remove("hidden");
  const preview = JSON.stringify(exportObj, null, 2);
  reportPreview.textContent = preview;

  downloadJsonBtn.onclick = ()=>{
    const fn = `lesetraining_${exportObj.child}_${exportObj.mode}_${exportObj.session_id}.json`;
    downloadText(fn, preview, "application/json;charset=utf-8");
  };

  downloadCsvBtn.onclick = ()=>{
    const csv = toCSV(exportObj);
    const fn = `lesetraining_${exportObj.child}_${exportObj.mode}_${exportObj.session_id}.csv`;
    downloadText(fn, csv, "text/csv;charset=utf-8");
  };

  copyJsonBtn.onclick = async ()=>{
    try{
      await navigator.clipboard.writeText(preview);
      alert("JSON kopiert.");
    }catch(e){
      alert("Kopieren nicht m√∂glich (Browser-Einstellung). Nutze Download.");
    }
  };
}

/* Initial */
setTimeout(()=> speak("H√∂r gut zu und f√ºlle die L√ºcke."), 650);
updateStartState();
</script>
</body>
</html>
